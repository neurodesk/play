name: PR Preview Deploy

on:
  workflow_run:
    workflows: ["PR Preview Build"]
    types:
      - completed

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: pr-preview-deploy
  cancel-in-progress: false

jobs:
  deploy:
    # Only deploy if the build succeeded and came from a pull_request event
    # SECURITY NOTE: This condition does NOT prevent artifact tampering!
    # An attacker can submit a PR that modifies pr-build.yml to tamper with
    # artifact contents before upload. That's why we validate all metadata
    # from artifacts before use (see "Validate PR metadata" step).
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Find PR number from artifacts
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            const prArtifact = artifacts.data.artifacts.find(artifact => 
              artifact.name.startsWith('pr-preview-')
            );
            
            if (!prArtifact) {
              throw new Error('No PR preview artifact found');
            }
            
            const prNumber = prArtifact.name.replace('pr-preview-', '');
            console.log(`Found PR number: ${prNumber}`);
            return prNumber;
          result-encoding: string

      - name: Validate PR number
        id: validate-pr
        run: |
          set -euo pipefail
          PR="${{ steps.find-pr.outputs.result }}"
          if ! [[ "$PR" =~ ^[0-9]+$ ]]; then
            echo "Invalid PR number: '$PR'" >&2
            exit 1
          fi
          echo "Validated PR number: $PR"
          echo "pr-number=$PR" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-preview-${{ steps.validate-pr.outputs.pr-number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: false

      - name: Read PR metadata
        # SECURITY: This reads metadata from artifacts which could be tampered with.
        # These values are UNTRUSTED and must be validated before use.
        # Validation happens in the next step before any dangerous operations.
        id: pr-meta
        run: |
          PR_NUMBER=$(cat pr-metadata/pr-number.txt)
          BASE_REPO=$(cat pr-metadata/base-repo.txt)
          BASE_OWNER=$(cat pr-metadata/base-owner.txt)
          BASE_NAME=$(cat pr-metadata/base-name.txt)
          HEAD_SHA=$(cat pr-metadata/head-sha.txt)
          HEAD_REF=$(cat pr-metadata/head-ref.txt)
          
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "base-repo=${BASE_REPO}" >> $GITHUB_OUTPUT
          echo "base-owner=${BASE_OWNER}" >> $GITHUB_OUTPUT
          echo "base-name=${BASE_NAME}" >> $GITHUB_OUTPUT
          echo "head-sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
          echo "head-ref=${HEAD_REF}" >> $GITHUB_OUTPUT

      - name: Validate PR metadata
        # SECURITY: This step validates untrusted data from artifacts before use.
        # 
        # Why this pattern is safe:
        # 1. Expression evaluation (${{ }}) happens ONCE when GitHub Actions sets env vars
        # 2. The run script reads env vars using shell syntax ($VAR), NOT ${{ env.VAR }}
        # 3. No secondary expression evaluation occurs - values are literal strings
        # 4. Validation runs immediately before any dangerous operations
        # 
        # Attack mitigation:
        # - Even if artifact contains malicious content like "; rm -rf /"
        # - It becomes a literal string in the env var, NOT executable code
        # - Validation regex blocks any non-whitelisted characters
        # - Whitelist-only approach (not blacklist) prevents bypass attempts
        # 
        # CodeQL may flag this as "code injection" because it traces untrusted data
        # flow into expressions. This is a false positive - the env block pattern
        # is GitHub's recommended approach and prevents actual code execution.
        # See: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-an-intermediate-environment-variable
        env:
          BASE_REPO: ${{ steps.pr-meta.outputs.base-repo }}
          BASE_OWNER: ${{ steps.pr-meta.outputs.base-owner }}
          BASE_NAME: ${{ steps.pr-meta.outputs.base-name }}
          HEAD_SHA: ${{ steps.pr-meta.outputs.head-sha }}
          HEAD_REF: ${{ steps.pr-meta.outputs.head-ref }}
          PR_NUMBER: ${{ steps.pr-meta.outputs.pr-number }}
        run: |
          set -euo pipefail
          
          # Validate BASE_REPO format (owner/repo)
          # Note: GitHub allows dots in both owner and repo names
          if ! [[ "$BASE_REPO" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "Invalid BASE_REPO format: '$BASE_REPO'" >&2
            exit 1
          fi
          
          # Validate BASE_OWNER (alphanumeric, hyphens, underscores, dots)
          # Note: GitHub allows dots in organization names (rare but valid)
          if ! [[ "$BASE_OWNER" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
            echo "Invalid BASE_OWNER: '$BASE_OWNER'" >&2
            exit 1
          fi
          
          # Validate BASE_NAME (alphanumeric, hyphens, underscores, dots)
          if ! [[ "$BASE_NAME" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
            echo "Invalid BASE_NAME: '$BASE_NAME'" >&2
            exit 1
          fi
          
          # Validate HEAD_SHA (40 character hex)
          if ! [[ "$HEAD_SHA" =~ ^[a-fA-F0-9]{40}$ ]]; then
            echo "Invalid HEAD_SHA: '$HEAD_SHA'" >&2
            exit 1
          fi
          
          # Validate HEAD_REF (alphanumerics, hyphens, underscores, slashes, dots)
          if ! [[ "$HEAD_REF" =~ ^[a-zA-Z0-9/_.-]+$ ]]; then
            echo "Invalid HEAD_REF: '$HEAD_REF'" >&2
            exit 1
          fi
          
          # Validate PR_NUMBER from metadata (should match validated PR from artifact)
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Invalid PR_NUMBER in metadata: '$PR_NUMBER'" >&2
            exit 1
          fi
          
          # CRITICAL: Verify PR_NUMBER in metadata matches the artifact name
          # This prevents cross-PR attacks where attacker uploads artifact for PR #123
          # but includes different PR number in metadata to deploy to PR #456
          VALIDATED_PR="${{ steps.validate-pr.outputs.pr-number }}"
          if [[ "$PR_NUMBER" != "$VALIDATED_PR" ]]; then
            echo "PR number mismatch: artifact name has $VALIDATED_PR, metadata has $PR_NUMBER" >&2
            exit 1
          fi
          
          echo "All metadata validated successfully"

      - name: Remove legacy CNAME on gh-pages (target branch)
        if: ${{ steps.pr-meta.outputs.base-repo == 'neurodesk/neurodesk.github.io' }}
        env:
          PR_NUMBER: ${{ steps.pr-meta.outputs.pr-number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Cleaning legacy CNAME from gh-pages for pr-${PR_NUMBER}"
          # Clone gh-pages with token auth
          git clone --depth=1 --single-branch --branch gh-pages "https://x-access-token:${GH_TOKEN}@github.com/neurodesk/neurodesk.github.io.git" gh-pages-work
          cd gh-pages-work
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Remove any CNAME files under the PR preview path (root and static), if present
          TARGET_DIR="pr-${PR_NUMBER}"
          rm -f "${TARGET_DIR}/CNAME" || true
          rm -f "${TARGET_DIR}/static/CNAME" || true

          # Only commit if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore(preview): remove legacy CNAME for ${TARGET_DIR}"
            git push origin gh-pages
            echo "Pushed cleanup commit for ${TARGET_DIR}"
          else
            echo "No legacy CNAME found for ${TARGET_DIR}; nothing to clean"
          fi

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview-deploy
          destination_dir: .
          keep_files: true

      - name: Trigger Pages deploy to include previews
        if: ${{ steps.pr-meta.outputs.base-repo == 'neurodesk/neurodesk.github.io' }}
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr-meta.outputs.pr-number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        with:
          script: |
            // Kick off the main Pages workflow which merges pr-* from gh-pages
            const PR = String(process.env.PR_NUMBER || '').trim();
            const prNumber = Number(PR);
            if (!Number.isInteger(prNumber) || prNumber <= 0) {
              core.setFailed(`Invalid PR number: "${PR}"`);
              return;
            }
            const owner = process.env.REPO_OWNER;
            const repo = process.env.REPO_NAME;
            if (!owner || !repo) {
              core.setFailed('Missing required environment variables: REPO_OWNER or REPO_NAME');
              return;
            }
            await github.request('POST /repos/{owner}/{repo}/dispatches', {
              owner: owner,
              repo: repo,
              event_type: 'pr-preview-updated',
              client_payload: { pr: prNumber }
            });
            core.info('Triggered repository_dispatch: pr-preview-updated');

      - name: Comment preview URL
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr-meta.outputs.pr-number }}
          BASE_REPO: ${{ steps.pr-meta.outputs.base-repo }}
          BASE_OWNER: ${{ steps.pr-meta.outputs.base-owner }}
          BASE_NAME: ${{ steps.pr-meta.outputs.base-name }}
          HEAD_SHA: ${{ steps.pr-meta.outputs.head-sha }}
          HEAD_REF: ${{ steps.pr-meta.outputs.head-ref }}
          HUGO_VERSION: "0.146.0"
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const baseRepo = process.env.BASE_REPO;
            const baseOwner = process.env.BASE_OWNER;
            const baseName = process.env.BASE_NAME;
            const headSha = process.env.HEAD_SHA;
            const headRef = process.env.HEAD_REF;
            
            // Validate prNumber is a positive integer
            if (!Number.isInteger(prNumber) || prNumber <= 0) {
              core.setFailed(`Invalid PR number: "${process.env.PR_NUMBER}"`);
              return;
            }
            
            // Validate baseOwner and baseName before using in URL
            // Note: Consistent with bash validation - allows dots for organization names
            if (!/^[a-zA-Z0-9_.-]+$/.test(baseOwner)) {
              core.setFailed(`Invalid base owner: "${baseOwner}"`);
              return;
            }
            if (!/^[a-zA-Z0-9_.-]+$/.test(baseName)) {
              core.setFailed(`Invalid base name: "${baseName}"`);
              return;
            }
            
            // Validate headSha and headRef before use (defense-in-depth)
            if (!/^[a-fA-F0-9]{40}$/.test(headSha)) {
              core.setFailed(`Invalid head SHA: "${headSha}"`);
              return;
            }
            // Note: Forward slashes don't need escaping in JavaScript string regex
            if (!/^[a-zA-Z0-9/_.-]+$/.test(headRef)) {
              core.setFailed(`Invalid head ref: "${headRef}"`);
              return;
            }
            
            let previewUrl;
            if (baseRepo === 'neurodesk/neurodesk.github.io') {
              previewUrl = `https://neurodesk.github.io/pr-${prNumber}/`;
            } else {
              previewUrl = `https://${baseOwner}.github.io/${baseName}/pr-${prNumber}/`;
            }

            const marker = '<!-- pr-preview:neurodesk -->';
            const commentBody = `${marker}\n## Preview Deployment\n\n**Preview URL:** ${previewUrl}\n\n**Status:** The preview is being deployed (or will be live in ~1‚Äì3 minutes).\n\nQuick contributor self-check (please confirm before requesting reviewers):\n- Visual layout looks correct\n- Links and images load as expected\n- Please verify that recent changes were applied correctly\n\nIf this looks good, please react with a üëç to this comment.\nThis signals to maintainers that the preview has been validated and is ready for review.\n\n<details>\n<summary>Build Details</summary>\n\n- Commit: ${headSha.substring(0, 7)}\n- Branch: \`${headRef}\`\n- Hugo Version: ${process.env.HUGO_VERSION}\n- Deployed to: \`gh-pages\` branch at \`pr-${prNumber}/\`\n\n</details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            const botComment = comments.find(comment => comment.body && comment.body.includes(marker));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing preview comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new preview comment');
            }
