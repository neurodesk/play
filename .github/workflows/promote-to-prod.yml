name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to promote (default: main)"
        required: false
        default: "main"

permissions:
  contents: read

jobs:
  promote:
    runs-on: ubuntu-22.04
    env:
      HUGO_VERSION: "0.146.0"
      PROD_OWNER: "neurodesk"
      PROD_REPO: "neurodesk.org"
      PROD_BRANCH: "site"
    steps:
      - name: Install Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Checkout (staging)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          submodules: recursive

      - name: Set up Node and Python (optional)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps (optional)
        run: |
          npm ci || npm install
          python -m pip install --upgrade pip
          pip install requests

      - name: Build with Hugo (prod baseURL)
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          hugo --minify --baseURL "https://neurodesk.org/"
          echo "neurodesk.org" > public/CNAME

      - name: Include example-notebooks (clone gh-pages branch)
        run: |
          set -e
          NOTEBOOKS_DIR="${GITHUB_WORKSPACE}/public/example-notebooks"
          mkdir -p "$NOTEBOOKS_DIR"
          
          echo "Cloning example-notebooks repo gh-pages branch..."
          git clone --depth=1 --branch gh-pages https://github.com/neurodesk/example-notebooks.git /tmp/example-notebooks
          
          echo "Copying example-notebooks HTML into public/example-notebooks/..."
          # Copy all files from gh-pages root into public/example-notebooks/
          # Skip git/repo metadata
          cp -r /tmp/example-notebooks/* "$NOTEBOOKS_DIR/" || true
          
          # Verify some key files exist
          if [ -f "$NOTEBOOKS_DIR/intro.html" ]; then
            echo "✓ intro.html found in public/example-notebooks/"
          else
            echo "⚠ Warning: intro.html not found — notebooks may not have copied correctly"
          fi

      - name: Include neurocontainers-ui (build from source)
        run: |
          set -e
          UI_DIR="${GITHUB_WORKSPACE}/public/neurocontainers-ui"
          mkdir -p "$UI_DIR"
          
          echo "Building neurocontainers-ui from source..."
          # Clone the repo
          git clone --depth=1 https://github.com/neurodesk/neurocontainers-ui.git /tmp/neurocontainers-ui
          
          # Install Bun (same as deploy.yaml)
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          
          # Build it (same as deploy.yaml)
          cd /tmp/neurocontainers-ui
          bun install
          PAGES_BASE_PATH="/neurocontainers-ui/" bun run build
          
          # Copy built output to public/neurocontainers-ui/
          cp -r out/* "$UI_DIR/" || true
          
          # Verify files
          if [ -f "$UI_DIR/index.html" ]; then
            echo "✓ neurocontainers-ui built and copied successfully"
          else
            echo "⚠ Warning: neurocontainers-ui build failed or output not found"
            exit 1
          fi

      - name: Push built site to prod repo
        env:
          GH_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
        run: |
          set -e
          WORK=/tmp/prod-site
          rm -rf "$WORK"
          mkdir -p "$WORK"
          cd "$WORK"
          git init
          git config user.name "staging-promotion-bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ env.PROD_OWNER }}/${{ env.PROD_REPO }}.git"
          # Prepare target branch locally (create if it doesn't exist)
          git fetch origin "${{ env.PROD_BRANCH }}" || true
          if git ls-remote --exit-code --heads origin "${{ env.PROD_BRANCH }}" >/dev/null 2>&1; then
            git checkout -B "${{ env.PROD_BRANCH }}" "origin/${{ env.PROD_BRANCH }}"
          else
            git checkout --orphan "${{ env.PROD_BRANCH }}"
          fi
          # Sync built files into repo root, but NEVER delete .git
          rsync -av --delete --exclude='.git' "${GITHUB_WORKSPACE}/public/" ./
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy from $GITHUB_REPOSITORY@$GITHUB_SHA"
            git push -u origin "${{ env.PROD_BRANCH }}"
          fi

      - name: Trigger production deploy workflow
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
        run: |
          # Fire repository_dispatch to prod to publish the 'site' branch content
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/${{ env.PROD_OWNER }}/${{ env.PROD_REPO }}/dispatches \
            -d '{"event_type":"publish-site","client_payload":{}}'
