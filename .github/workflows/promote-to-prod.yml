name: Promote to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to promote (default: main)"
        required: false
        default: "main"

permissions:
  contents: read

jobs:
  promote:
    runs-on: ubuntu-22.04
    env:
      HUGO_VERSION: "0.146.0"
      PROD_OWNER: "neurodesk"
      PROD_REPO: "neurodesk.org"
      PROD_BRANCH: "site"
    steps:
      - name: Install Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Checkout (staging)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          submodules: recursive

      - name: Set up Node and Python (optional)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps (optional)
        run: |
          npm ci || npm install
          python -m pip install --upgrade pip
          pip install requests

      - name: Build applications index (applist.json)
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
        run: |
          set -e
          if [ -n "$ZENODO_TOKEN" ]; then
            echo "ZENODO_TOKEN present — generating assets/js/applist.json via script"
            python .github/workflows/write-app-json.py --zenodo_token "$ZENODO_TOKEN"
          else
            echo "ZENODO_TOKEN not set — falling back to staging index.json"
            # Best-effort fallback so prod still has application data
            mkdir -p assets/js
            if curl -fsSL https://neurodesk.github.io/index.json -o /tmp/index.json; then
              # index.json has the same structure we need, write it to applist.json
              cp /tmp/index.json assets/js/applist.json
              echo "Fetched staging index.json and wrote to assets/js/applist.json"
            else
              echo "Warning: could not fetch staging index.json; Applications page may be empty"
            fi
          fi

      - name: Build with Hugo (prod baseURL)
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          hugo --minify --baseURL "https://neurodesk.org/"
          echo "neurodesk.org" > public/CNAME

      - name: Verify Applications JSON (non-empty)
        run: |
          set -e
          if [ ! -f public/index.json ]; then
            echo "public/index.json missing; Applications page will be empty"
            exit 1
          fi
          node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('public/index.json','utf8'));const n=Array.isArray(d.list)?d.list.length:0;console.log('Applications in index.json:',n);if(n===0){process.exit(1)}"

      - name: Include example-notebooks (clone gh-pages branch)
        run: |
          set -e
          NOTEBOOKS_DIR="${GITHUB_WORKSPACE}/public/example-notebooks"
          mkdir -p "$NOTEBOOKS_DIR"
          
          echo "Cloning example-notebooks repo gh-pages branch..."
          git clone --depth=1 --branch gh-pages https://github.com/neurodesk/example-notebooks.git /tmp/example-notebooks
          
          echo "Copying example-notebooks HTML into public/example-notebooks/..."
          # Copy all files from gh-pages root into public/example-notebooks/
          # Skip git/repo metadata
          cp -r /tmp/example-notebooks/* "$NOTEBOOKS_DIR/" || true
          
          # Verify some key files exist
          if [ -f "$NOTEBOOKS_DIR/intro.html" ]; then
            echo "✓ intro.html found in public/example-notebooks/"
          else
            echo "⚠ Warning: intro.html not found — notebooks may not have copied correctly"
          fi

      - name: Checkout neurocontainers-ui (source)
        run: |
          set -e
          mkdir -p "${GITHUB_WORKSPACE}/.tmp"
          git clone --depth=1 https://github.com/neurodesk/neurocontainers-ui.git "${GITHUB_WORKSPACE}/.tmp/neurocontainers-ui"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ${{ github.workspace }}/.tmp/neurocontainers-ui/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('.tmp/neurocontainers-ui/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Build neurocontainers-ui (export)
        working-directory: ${{ github.workspace }}/.tmp/neurocontainers-ui
        run: |
          set -e
          bun install
          # NOTE: Next.js expects basePath without a trailing slash
          PAGES_BASE_PATH="/neurocontainers-ui" bun run build
          echo "Built output (out/):"
          ls -la out || true

      - name: Copy neurocontainers-ui to public
        env:
          UI_DIR: ${{ github.workspace }}/public/neurocontainers-ui
        run: |
          set -e
          mkdir -p "$UI_DIR"
          rsync -av --delete "${GITHUB_WORKSPACE}/.tmp/neurocontainers-ui/out/" "$UI_DIR/"
          if [ -f "$UI_DIR/index.html" ]; then
            echo "✓ neurocontainers-ui built and copied successfully"
          else
            echo "⚠ Warning: neurocontainers-ui build failed or output not found"
            ls -la "$UI_DIR" || true
            exit 1
          fi

      - name: Push built site to prod repo
        env:
          GH_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
        run: |
          set -e
          WORK=/tmp/prod-site
          rm -rf "$WORK"
          mkdir -p "$WORK"
          cd "$WORK"
          git init
          git config user.name "staging-promotion-bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ env.PROD_OWNER }}/${{ env.PROD_REPO }}.git"
          # Prepare target branch locally (create if it doesn't exist)
          git fetch origin "${{ env.PROD_BRANCH }}" || true
          if git ls-remote --exit-code --heads origin "${{ env.PROD_BRANCH }}" >/dev/null 2>&1; then
            git checkout -B "${{ env.PROD_BRANCH }}" "origin/${{ env.PROD_BRANCH }}"
          else
            git checkout --orphan "${{ env.PROD_BRANCH }}"
          fi
          # Sync built files into repo root, but NEVER delete .git
          rsync -av --delete --exclude='.git' "${GITHUB_WORKSPACE}/public/" ./
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy from $GITHUB_REPOSITORY@$GITHUB_SHA"
            git push -u origin "${{ env.PROD_BRANCH }}"
          fi

      - name: Trigger production deploy workflow
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PROD_REPO_TOKEN }}
        run: |
          # Fire repository_dispatch to prod to publish the 'site' branch content
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/${{ env.PROD_OWNER }}/${{ env.PROD_REPO }}/dispatches \
            -d '{"event_type":"publish-site","client_payload":{}}'
